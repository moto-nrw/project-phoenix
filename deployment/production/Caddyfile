# Project Phoenix Production Caddy Configuration
# Last updated: May 19, 2025
# Maintainer: y.wenger@gmx.de

# Global options
{
    # Admin API endpoint
    admin localhost:2019
    
    # Email for Let's Encrypt certificates
    email {$ADMIN_EMAIL}
    
    # Optional: staging certificates for testing
    # acme_ca https://acme-staging-v02.api.letsencrypt.org/directory
}

# Backend API - Phoenix Server
{$API_DOMAIN} {
    # Reverse proxy to backend service
    reverse_proxy localhost:8080 {
        # Health check - commented out for now
        # health_uri /health
        # health_interval 30s
        
        # Headers
        header_up X-Real-IP {remote}
    }
    
    # Security headers
    header {
        X-Content-Type-Options "nosniff"
        X-Frame-Options "DENY"
        X-XSS-Protection "1; mode=block"
        -Server  # Remove server header
    }
    
    # Logging
    log {
        output file /var/log/caddy/api.moto-app.de.log {
            # roll_size: When log file reaches this size, it gets rotated
            roll_size 10mb
            # roll_keep: Number of old log files to keep
            roll_keep 10
            # roll_keep_for: How long to keep old logs (720h = 30 days)
            roll_keep_for 720h
        }
        format json
    }
    
    # Request timeout for uploads (using timeouts directive)
    @upload {
        path /api/upload/*
    }
    handle @upload {
        reverse_proxy localhost:8080 {
            # Longer timeout for uploads
            transport http {
                read_timeout 5m
                write_timeout 5m
            }
        }
    }
}

# Frontend - Phoenix NextJS App  
{$DOMAIN} {
    # Reverse proxy to frontend service
    reverse_proxy localhost:3000 {
        # Headers for SSR
        header_up Host {host}
        header_up X-Real-IP {remote}
    }
    
    # Security headers
    header {
        Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"
        X-Content-Type-Options "nosniff"
        X-Frame-Options "DENY"
        X-XSS-Protection "1; mode=block"
        Referrer-Policy "strict-origin-when-cross-origin"
        Permissions-Policy "camera=(), microphone=(), geolocation=()"
        -Server  # Remove server header
    }
    
    # Caching for static assets
    @static {
        path /_next/static/*
        path /static/*
        path *.js *.css *.jpg *.jpeg *.png *.gif *.ico *.svg *.woff *.woff2
    }
    header @static Cache-Control "public, max-age=31536000, immutable"
    
    # Logging
    log {
        output file /var/log/caddy/moto-app.de.log {
            # roll_size: When log file reaches this size, it gets rotated
            roll_size 10mb
            # roll_keep: Number of old log files to keep
            roll_keep 10
            # roll_keep_for: How long to keep old logs (720h = 30 days)
            roll_keep_for 720h
        }
        format json
    }
    
    # Handle www redirect
    @www {
        host www.{$DOMAIN}
    }
    redir @www https://{$DOMAIN}{uri} permanent
}

# Optional: Health check endpoint
localhost:2020 {
    respond /health "OK" 200
}