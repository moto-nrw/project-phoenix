# Docker Compose configuration for running server with automated cleanup scheduler
# This can be used alongside or instead of the main docker-compose.yml

version: '3.8'

services:
  # Main server with built-in scheduler enabled
  server-with-scheduler:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: phoenix-server-scheduler
    environment:
      # Database connection
      DB_DSN: ${DB_DSN:-postgres://postgres:postgres@postgres:5432/postgres?sslmode=require}
      
      # Enable built-in cleanup scheduler
      CLEANUP_SCHEDULER_ENABLED: "true"
      CLEANUP_SCHEDULER_TIME: ${CLEANUP_SCHEDULER_TIME:-02:00}
      CLEANUP_SCHEDULER_TIMEOUT_MINUTES: ${CLEANUP_SCHEDULER_TIMEOUT_MINUTES:-30}
      
      # Other required environment variables
      AUTH_JWT_SECRET: ${AUTH_JWT_SECRET}
      AUTH_JWT_EXPIRY: ${AUTH_JWT_EXPIRY:-15m}
      AUTH_JWT_REFRESH_EXPIRY: ${AUTH_JWT_REFRESH_EXPIRY:-1h}
      LOG_LEVEL: ${LOG_LEVEL:-info}
      ENABLE_CORS: ${ENABLE_CORS:-false}
      PORT: ${PORT:-8080}
      
      # Admin account
      ADMIN_EMAIL: ${ADMIN_EMAIL:-admin@example.com}
      ADMIN_PASSWORD: ${ADMIN_PASSWORD}
    volumes:
      - ./backend/logs:/app/logs
      - ./config/ssl/postgres/certs:/certs:ro
    networks:
      - phoenix-network
    ports:
      - "8080:8080"
    depends_on:
      postgres:
        condition: service_healthy
    command: ./main serve
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:8080/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  # Alternative: Run cleanup as a one-off task (for testing or manual execution)
  cleanup-manual:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: phoenix-cleanup-manual
    environment:
      DB_DSN: ${DB_DSN:-postgres://postgres:postgres@postgres:5432/postgres?sslmode=require}
      AUTH_JWT_SECRET: ${AUTH_JWT_SECRET}
      LOG_LEVEL: ${LOG_LEVEL:-info}
    volumes:
      - ./config/ssl/postgres/certs:/certs:ro
    networks:
      - phoenix-network
    depends_on:
      postgres:
        condition: service_healthy
    command: ./main cleanup visits
    # This service exits after running, no restart
    restart: "no"

networks:
  phoenix-network:
    external: true
    name: project-phoenix_default