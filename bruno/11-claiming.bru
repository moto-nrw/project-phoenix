meta {
  name: 11 - Group Claiming Workflow
  type: http
  seq: 11
}

get {
  url: {{baseUrl}}/api/active/groups/unclaimed
  body: none
  auth: bearer
}

auth:bearer {
  token: {{accessToken}}
}

docs {
  ## Group Claiming Workflow Tests

  Tests the deviceless group claiming feature:
  1. List unclaimed groups (main request)
  2. Claim Schulhof group as supervisor
  3. Verify claim assignment
  4. Duplicate claim attempt (error expected)
  5. Cleanup - release supervisor assignment

  **Prerequisites:**
  - accessToken configured (teacher account)
  - Schulhof group exists (from test 10) or other unclaimed groups
  - Teacher has permission to claim groups

  **Feature:**
  Teachers can claim deviceless groups (e.g., Schulhof auto-created)
  to supervise activities without using RFID device

  **Cleanup:**
  Test 5 releases supervisor assignment to restore state
  (Note: If API lacks unclaim endpoint, document manual cleanup)
}

script:pre-request {
  // Ensure teacher/admin token exists
  if (!bru.getEnvVar("accessToken")) {
    await bru.sendRequest({
      method: 'POST',
      url: bru.getEnvVar("baseUrl") + "/auth/login",
      headers: { "Content-Type": "application/json" },
      data: {
        email: bru.getEnvVar("testStaffEmail") || "admin@example.com",
        password: bru.getEnvVar("testStaffPassword") || "Test1234%"
      }
    }, function(err, response) {
      if (!err && response.status === 200) {
        bru.setEnvVar("accessToken", response.data.access_token);
      }
    });
  }
}

script:post-response {
  // Test 1: List unclaimed groups
  test("Unclaimed groups endpoint responds", function() {
    expect(res.getStatus()).to.equal(200);
    expect(res.getBody()).to.have.property('status', 'success');
    expect(res.getBody().data).to.be.an('array');
  });

  if (res.status === 200) {
    const unclaimedGroups = res.body.data;
    console.log(`‚úÖ Unclaimed groups: ${unclaimedGroups.length} found`);

    const accessToken = bru.getEnvVar("accessToken");

    // Find a Schulhof group or any unclaimed group
    const groupToClaim = unclaimedGroups.find(g =>
      g.name && g.name.toLowerCase().includes('schulhof')
    ) || unclaimedGroups[0];

    if (!groupToClaim) {
      console.log("‚ö†Ô∏è  No unclaimed groups available for testing");
      return;
    }

    const groupId = groupToClaim.id;
    bru.setVar("claimGroupId", groupId);
    console.log(`‚ÑπÔ∏è  Group to claim: ${groupToClaim.name} (ID: ${groupId})`);

    // Test 2: Claim Schulhof group as supervisor
    (async function() {
      await bru.sendRequest({
        method: 'POST',
        url: bru.getEnvVar("baseUrl") + `/api/active/groups/${groupId}/claim`,
        headers: {
          "Authorization": `Bearer ${accessToken}`,
          "Content-Type": "application/json"
        },
        data: {
          role: "supervisor"
        }
      }, function(err, claimResponse) {
        if (err) {
          if (err.message.includes('409')) {
            console.log("‚ÑπÔ∏è  Group already claimed");
          } else {
            test("Group claim", function() {
              throw new Error(`Claim failed: ${err.message}`);
            });
          }
          return;
        }

        test("Group claim succeeds or is already claimed", function() {
          // Accept both 200 (success) and 409 (already claimed)
          expect([200, 409]).to.include(claimResponse.status);
          expect(claimResponse.data).to.have.property('status');
        });

        if (claimResponse.status === 200) {
          bru.setVar("claimSucceeded", true);
          console.log(`‚úÖ Group ${groupId} claimed as supervisor`);
        } else if (claimResponse.status === 409) {
          console.log(`‚ÑπÔ∏è  Group ${groupId} already claimed (expected in some scenarios)`);
        }
      });
    })();

    // Test 3: Verify claim assignment
    (async function() {
      await bru.sendRequest({
        method: 'GET',
        url: bru.getEnvVar("baseUrl") + `/api/active/groups/${groupId}`,
        headers: {
          "Authorization": `Bearer ${accessToken}`
        }
      }, function(err, verifyResponse) {
        if (err) {
          test("Claim verification", function() {
            throw new Error(`Verification failed: ${err.message}`);
          });
          return;
        }

        test("Claimed group shows supervisor assignment", function() {
          expect(verifyResponse.status).to.equal(200);
          expect(verifyResponse.data).to.have.property('status', 'success');
          // Check if supervisors list exists (structure may vary)
          if (verifyResponse.data.data.supervisors) {
            expect(verifyResponse.data.data.supervisors).to.be.an('array');
          }
        });

        console.log("‚úÖ Claim verified");
      });
    })();

    // Test 4: Duplicate claim attempt (error expected)
    (async function() {
      await bru.sendRequest({
        method: 'POST',
        url: bru.getEnvVar("baseUrl") + `/api/active/groups/${groupId}/claim`,
        headers: {
          "Authorization": `Bearer ${accessToken}`,
          "Content-Type": "application/json"
        },
        data: {
          role: "supervisor"
        }
      }, function(err, dupResponse) {
        if (err) {
          if (err.message.includes('200') || err.message.includes('409')) {
            console.log("‚úÖ Duplicate claim handled");
          } else {
            test("Duplicate claim handling", function() {
              throw new Error(`Duplicate claim test failed: ${err.message}`);
            });
          }
          return;
        }

        test("Duplicate claim handled appropriately", function() {
          // Could be 200 (idempotent) or 409 (conflict)
          expect([200, 409]).to.include(dupResponse.status);
        });

        console.log(`‚úÖ Duplicate claim handled (status: ${dupResponse.status})`);
      });
    })();

    // Test 5: Cleanup - release supervisor assignment
    (async function() {
      const claimSucceeded = bru.getVar("claimSucceeded");

      if (!claimSucceeded) {
        console.log("‚ÑπÔ∏è  No claim to clean up");
        return;
      }

      // Attempt to unclaim/release supervisor
      await bru.sendRequest({
        method: 'POST',
        url: bru.getEnvVar("baseUrl") + `/api/active/groups/${groupId}/unclaim`,
        headers: {
          "Authorization": `Bearer ${accessToken}`,
          "Content-Type": "application/json"
        },
        data: {}
      }, function(err, unclaimResponse) {
        if (err) {
          // If unclaim endpoint doesn't exist, log for manual cleanup
          if (err.message.includes('404')) {
            console.log("‚ö†Ô∏è  Unclaim endpoint not available - manual cleanup may be needed:");
            console.log(`   - Group ID: ${groupId}`);
            console.log("   - Remove supervisor via database or end group session");
          } else {
            console.log(`‚ö†Ô∏è  Cleanup error (non-fatal): ${err.message}`);
          }
        } else {
          console.log(`üßπ Supervisor assignment released for group ${groupId}`);
        }
      });

      test("Cleanup completed", function() {
        expect(true).to.be.true;  // Cleanup always passes
      });
    })();
  }
}
