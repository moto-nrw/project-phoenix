meta {
  name: Device Session Start Multi (Edge Cases)
  type: http
  seq: 22
}

post {
  url: {{baseUrl}}/api/iot/session/start
  body: json
  auth: none
}

headers {
  Authorization: Bearer {{deviceApiKey}}
  x-device-pin: {{globalOgsPin}}
}

body:json {
  {
    "activity_id": 1,
    "room_id": 1,
    "supervisor_ids": [],
    "force": false
  }
}

tests {
  const scenario = bru.getVar("testScenario") || "empty";
  
  if (scenario === "empty") {
    test("Empty supervisor array returns error", function() {
      expect(res.getStatus()).to.equal(400);
      expect(res.getBody()).to.have.property('message');
      expect(res.getBody().message).to.include('at least one supervisor');
    });
  }
  
  if (scenario === "invalid") {
    test("Invalid supervisor ID returns error", function() {
      expect(res.getStatus()).to.not.equal(200);
      expect(res.getBody()).to.have.property('message');
    });
  }
  
  if (scenario === "duplicate") {
    test("Duplicate supervisor IDs are handled", function() {
      if (res.getStatus() === 200) {
        const data = res.getBody().data;
        expect(data).to.have.property('supervisors');
        
        // Check that duplicates were removed
        const uniqueIds = new Set(data.supervisors.map(s => s.staff_id));
        expect(uniqueIds.size).to.equal(data.supervisors.length);
      }
    });
  }
  
  if (scenario === "single") {
    test("Single supervisor works correctly", function() {
      expect(res.getStatus()).to.equal(200);
      const data = res.getBody().data;
      expect(data.supervisors).to.have.lengthOf(1);
      expect(data.supervisors[0].staff_id).to.equal(1);
    });
  }
}

script:pre-request {
  const scenario = bru.getEnvVar("edgeScenario") || "empty";
  bru.setVar("testScenario", scenario);
  
  // Configure request based on scenario
  const body = JSON.parse(req.getBody());
  
  switch(scenario) {
    case "empty":
      body.supervisor_ids = [];
      break;
    case "invalid":
      body.supervisor_ids = [99999]; // Non-existent ID
      break;
    case "duplicate":
      body.supervisor_ids = [1, 2, 1, 3, 2]; // Duplicates
      break;
    case "single":
      body.supervisor_ids = [1]; // Single supervisor
      break;
  }
  
  req.setBody(JSON.stringify(body));
}

script:post-response {
  const scenario = bru.getVar("testScenario");
  
  if (scenario === "empty") {
    console.log("✅ Empty supervisor array correctly rejected");
  } else if (scenario === "invalid") {
    console.log("✅ Invalid supervisor ID correctly rejected");
  } else if (scenario === "duplicate") {
    if (res.status === 200) {
      console.log("✅ Duplicate supervisor IDs handled correctly");
      const data = res.body.data;
      console.log(`Input had duplicates, result has ${data.supervisors.length} unique supervisors`);
    }
  } else if (scenario === "single") {
    if (res.status === 200) {
      console.log("✅ Single supervisor session started successfully");
    }
  }
  
  // Clean up session if created
  if (res.status === 200 && res.body.data && res.body.data.active_group_id) {
    bru.setVar("lastActiveGroupId", res.body.data.active_group_id);
  }
}