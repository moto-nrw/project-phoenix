meta {
  name: Update Session Supervisors
  type: http
  seq: 61
}

put {
  url: {{baseUrl}}/api/iot/session/{{activeGroupId}}/supervisors
  body: json
  auth: none
}

headers {
  X-API-Key: {{deviceApiKey}}
  X-Device-PIN: {{devicePin}}
  Content-Type: application/json
}

body:json {
  {
    "supervisor_ids": [2, 4, 5]
  }
}

script:pre-request {
  // First, start a session to get an active group ID
  const startRequest = {
    method: 'POST',
    url: bru.getEnvVar('baseUrl') + '/api/iot/session/start',
    headers: {
      'X-API-Key': bru.getEnvVar('deviceApiKey'),
      'X-Device-PIN': bru.getEnvVar('devicePin'),
      'Content-Type': 'application/json'
    },
    body: {
      mode: 'raw',
      raw: JSON.stringify({
        activity_id: 101,
        room_id: 1,
        supervisor_ids: [1, 2, 3],
        force: true
      })
    }
  };

  const startResponse = await bru.http.request(startRequest);
  
  if (startResponse.status === 200 && startResponse.data.data) {
    // Store the active group ID for the update request
    bru.setVar('activeGroupId', startResponse.data.data.active_group_id);
    console.log('Started session with active group ID:', startResponse.data.data.active_group_id);
    console.log('Initial supervisors:', startResponse.data.data.supervisors.map(s => s.staff_id));
  } else {
    throw new Error('Failed to start session: ' + JSON.stringify(startResponse.data));
  }
}

script:post-response {
  if (res.status === 200 && res.body.data) {
    console.log('✓ Supervisors updated successfully');
    console.log('Active Group ID:', res.body.data.active_group_id);
    console.log('New supervisors:');
    res.body.data.supervisors.forEach(s => {
      console.log(`  - ${s.display_name} (ID: ${s.staff_id}, Role: ${s.role})`);
    });
    
    // Verify the correct supervisors are returned
    const supervisorIds = res.body.data.supervisors.map(s => s.staff_id).sort();
    const expectedIds = [2, 4, 5].sort();
    
    if (JSON.stringify(supervisorIds) === JSON.stringify(expectedIds)) {
      console.log('✓ Supervisor IDs match expected values');
    } else {
      console.error('✗ Supervisor IDs do not match! Expected:', expectedIds, 'Got:', supervisorIds);
    }
    
    // Clean up - end the session
    const endRequest = {
      method: 'POST',
      url: bru.getEnvVar('baseUrl') + '/api/iot/session/end',
      headers: {
        'X-API-Key': bru.getEnvVar('deviceApiKey'),
        'X-Device-PIN': bru.getEnvVar('devicePin')
      }
    };
    
    const endResponse = await bru.http.request(endRequest);
    if (endResponse.status === 200) {
      console.log('✓ Session ended successfully');
    }
  } else {
    console.error('Failed to update supervisors:', res.status, res.body);
  }
}

docs {
  # Update Session Supervisors
  
  This endpoint allows devices to update the list of supervisors for an active session.
  
  ## Usage
  
  PUT `/api/iot/session/{sessionId}/supervisors`
  
  ### Request Body
  ```json
  {
    "supervisor_ids": [2, 4, 5]  // Complete new list of supervisor staff IDs
  }
  ```
  
  ### Response
  ```json
  {
    "status": "success",
    "data": {
      "active_group_id": 123,
      "supervisors": [
        {
          "staff_id": 2,
          "first_name": "Julian",
          "last_name": "Müller",
          "display_name": "Julian Müller",
          "role": "supervisor"
        },
        {
          "staff_id": 4,
          "first_name": "Anna",
          "last_name": "Schmidt",
          "display_name": "Anna Schmidt",
          "role": "supervisor"
        },
        {
          "staff_id": 5,
          "first_name": "Hans",
          "last_name": "Weber",
          "display_name": "Hans Weber",
          "role": "supervisor"
        }
      ],
      "status": "success",
      "message": "Supervisors updated successfully"
    },
    "message": "Supervisors updated successfully"
  }
  ```
  
  ## Notes
  - This is a PUT operation that replaces all supervisors
  - At least one supervisor must be provided
  - The operation is atomic - all changes happen in a transaction
  - Previous supervisors are soft-deleted (end_date is set)
  - Duplicate supervisor IDs are automatically deduplicated
}