meta {
  name: Room Conflict Validation
  type: http
  seq: 20
}

post {
  url: {{baseUrl}}/api/active/groups
  body: json
  auth: bearer
}

auth:bearer {
  token: {{accessToken}}
}

headers {
  Content-Type: application/json
}

body:json {
  {
    "group_id": 5,
    "room_id": 5,
    "start_time": "{{currentTime}}",
    "last_activity": "{{currentTime}}",
    "timeout_minutes": 60
  }
}

script:pre-request {
  bru.setVar("currentTime", new Date().toISOString());
}

tests {
  test("Room conflict test - Timestamp parsing fix validation", function() {
    const status = res.getStatus();
    const body = res.getBody();
    
    // Should succeed on first creation OR show room conflict (both are valid)
    if (status === 201 || status === 200) {
      expect(body).to.have.property('status', 'success');
      expect(body).to.have.property('data');
      expect(body.data).to.have.property('id');
      expect(body.data).to.have.property('room_id', 5);
      
      console.log(`‚úÖ SUCCESS: Timestamp parsing fixed! Created active group ${body.data.id} in room 5`);
      console.log(`   This confirms the JavaScript variable issue has been resolved.`);
    } else if (status === 500 && body.error && body.error.includes('room is already occupied')) {
      // Room 5 is already occupied - this also indicates timestamp parsing worked
      console.log(`‚úÖ SUCCESS: Timestamp parsing fixed! Room conflict detected properly.`);
      console.log(`   This confirms the JavaScript variable issue has been resolved.`);
    } else if (status === 400 && body.error && body.error.includes('parsing time')) {
      // This would indicate the timestamp issue still exists
      throw new Error(`‚ùå TIMESTAMP ISSUE STILL EXISTS: ${body.error}`);
    } else {
      throw new Error(`Unexpected response: ${status} - ${JSON.stringify(body)}`);
    }
  });
}

script:post-response {
  // Simple validation that timestamp parsing is working
  const status = res.getStatus();
  const body = res.getBody();
  
  if (status === 201 || status === 200) {
    console.log("üéâ ISSUE RESOLVED: JavaScript timestamp variable is now working correctly!");
    console.log("   The literal 'new Date().toISOString()' string is no longer being sent.");
  } else if (status === 500 && body.error && body.error.includes('room is already occupied')) {
    console.log("üéâ ISSUE RESOLVED: JavaScript timestamp variable is working correctly!");
    console.log("   Room conflict detection is functioning (timestamps parsed successfully).");
  }
}