meta {
  name: Device Session Conflict Check
  type: http
  seq: 16
}

post {
  url: {{baseUrl}}/api/iot/session/check-conflict
  body: json
  auth: none
}

headers {
  Authorization: Bearer {{deviceApiKey}}
  X-Staff-PIN: {{staffPIN}}
  Content-Type: application/json
}

body:json {
  {
    "activity_id": 1
  }
}

tests {
  test("should return 200 or 409", function() {
    const status = res.getStatus();
    expect([200, 409]).to.include(status);
  });
  
  test("should return conflict info structure", function() {
    const body = res.getBody();
    expect(body).to.have.property('status', 'success');
    expect(body).to.have.property('data');
    expect(body.data).to.have.property('has_conflict');
    expect(body.data).to.have.property('conflict_message');
    expect(body.data).to.have.property('can_override');
    
    if (body.data.has_conflict) {
      expect(body.data.conflict_message).to.be.a('string');
      expect(body.data.conflict_message.length).to.be.greaterThan(0);
    }
  });
}

script:post-response {
  if (res.status === 200 || res.status === 409) {
    const data = res.body.data;
    if (data.has_conflict) {
      console.log(`⚠️  Conflict detected - ${data.conflict_message}`);
      console.log(`   Can override: ${data.can_override}`);
      if (data.conflicting_device) {
        console.log(`   Conflicting device: ${data.conflicting_device}`);
      }
    } else {
      console.log(`✅ No conflicts - Activity 1 available for session start`);
    }
  } else {
    console.log("❌ Conflict check failed");
  }
}