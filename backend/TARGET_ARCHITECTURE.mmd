graph TD
    %% ---------------- Styles ----------------
    classDef client fill:#ffece6,stroke:#ff6d00,stroke-width:2px,color:black
    classDef api fill:#e3f2fd,stroke:#1565c0,stroke-width:2px,color:black
    classDef service fill:#fff9c4,stroke:#fbc02d,stroke-width:2px,color:black
    classDef repo fill:#e8f5e9,stroke:#2e7d32,stroke-width:2px,color:black
    classDef db fill:#f3e5f5,stroke:#7b1fa2,stroke-width:2px,color:black
    classDef model fill:#eeeeee,stroke:#9e9e9e,stroke-width:1px,stroke-dasharray: 5 5,color:black

    %% ---------------- Nodes ----------------
    User((Client / IoT)):::client

    subgraph Presentation_Layer ["Presentation Layer (API Package)"]
        direction TB
        Router[Chi Router & Middleware]:::api
        Handler[Handler Functions]:::api
        DTO[Request/Response DTOs]:::api
        Desc1[Handles HTTP, JSON, Validation.<br/>Knows NOTHING about Database.]:::model
    end

    subgraph Business_Layer ["Business Layer (Services Package)"]
        direction TB
        ServiceLogic[Service Implementation]:::service
        ServiceIFace[[Service Interface]]:::service
        Desc2[Pure Business Logic.<br/>Orchestrates Data Flow.<br/>Defines Repository Interfaces.]:::model
    end

    subgraph Domain_Core ["Domain Core (Models Package)"]
        DomainModel[Domain Structs / Entities]:::service
        Desc3[Pure Go Structs.<br/>No External Dependencies.<br/>Used by all layers.]:::model
    end

    subgraph Data_Access_Layer ["Data Access Layer (Repositories Package)"]
        direction TB
        RepoImp[Repository Implementation]:::repo
        RepoIFace[[Repository Interface]]:::repo
        QueryBuilder[Query Builder / ORM]:::repo
        Desc4[Constructs SQL.<br/>Maps Rows to Domain Models.<br/>Implements Interface defined by Service.]:::model
    end

    subgraph Persistence ["Persistence"]
        Database[(PostgreSQL)]:::db
    end

    %% ---------------- Flows ----------------

    %% Request Flow (Downstream)
    User -->|1. HTTP Request| Router
    Router -->|2. Route| Handler
    Handler -->|3. Bind & Validate| DTO
    Handler -->|4. Call| ServiceIFace
    ServiceIFace -.->|Implemented By| ServiceLogic
    ServiceLogic -->|5. Logic & Rules| DomainModel
    ServiceLogic -->|6. Fetch/Save| RepoIFace
    RepoIFace -.->|Implemented By| RepoImp
    RepoImp -->|7. Build Query No Raw SQL| QueryBuilder
    QueryBuilder -->|8. Execute| Database

    %% Response Flow (Upstream)
    Database -- 9. Raw Rows --> QueryBuilder
    QueryBuilder -- 10. Scan --> RepoImp
    RepoImp -- 11. Return Domain Model --> ServiceLogic
    ServiceLogic -- 12. Return Result --> Handler
    Handler -- 13. Map to DTO --> DTO
    DTO -- 14. JSON Response --> User

    %% Dependencies
    Handler -.- ServiceLogic
    ServiceLogic -.- DomainModel
    RepoImp -.- DomainModel
