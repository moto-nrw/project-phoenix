@startuml Project Phoenix - Backend Component Diagram (C4 Level 3)
!include https://raw.githubusercontent.com/plantuml-stdlib/C4-PlantUML/master/C4_Component.puml

title Project Phoenix - Backend Components

Container_Ext(frontend, "Frontend", "Next.js", "Web application")
Container_Ext(rfid, "RFID Device", "Hardware", "RFID reader")
ContainerDb(database, "Database", "PostgreSQL 17+", "Multi-schema data store")

Container_Boundary(backend, "Backend API (Go)") {
    Component(router, "Chi Router", "Go Chi v5", "Routes HTTP requests to appropriate handlers")

    Component(middleware_auth, "JWT Middleware", "auth/jwt", "Verifies and validates JWT tokens")
    Component(middleware_perm, "Permission Middleware", "auth/authorize", "Checks user permissions for resources")
    Component(middleware_security, "Security Middleware", "middleware", "CORS, rate limiting, security headers")

    Component(api_auth, "Auth API", "api/auth", "Login, logout, token refresh endpoints")
    Component(api_groups, "Groups API", "api/groups", "Group management endpoints")
    Component(api_students, "Students API", "api/students", "Student management endpoints")
    Component(api_active, "Active Sessions API", "api/active", "Real-time session tracking endpoints")
    Component(api_iot, "IoT API", "api/iot", "RFID device integration endpoints")
    Component(api_sse, "SSE Hub", "realtime/hub", "Server-Sent Events broadcasting")

    Component(service_auth, "Auth Service", "services/auth", "Authentication and authorization logic")
    Component(service_education, "Education Service", "services/education", "Group management business logic")
    Component(service_users, "User Service", "services/users", "Student/teacher management logic")
    Component(service_active, "Active Service", "services/active", "Session and visit tracking logic")
    Component(service_iot, "IoT Service", "services/iot", "Device management and PIN validation")

    Component(repo_account, "Account Repository", "database/repositories/auth", "Account data access")
    Component(repo_group, "Group Repository", "database/repositories/education", "Group data access")
    Component(repo_student, "Student Repository", "database/repositories/users", "Student data access")
    Component(repo_active, "Active Repository", "database/repositories/active", "Session data access")
    Component(repo_device, "Device Repository", "database/repositories/iot", "Device data access")

    Component(orm, "BUN ORM", "uptrace/bun", "Type-safe PostgreSQL ORM with multi-schema support")
}

' External interactions
Rel(frontend, router, "HTTP requests", "HTTPS/JSON (Bearer token)")
Rel(rfid, router, "Check-in/out events", "HTTPS/JSON (API key + PIN)")
Rel(frontend, api_sse, "Subscribe to events", "SSE")

' Router to middleware
Rel(router, middleware_security, "All requests", "CORS, rate limit, headers")
Rel(router, middleware_auth, "Protected routes", "JWT verification")
Rel(router, middleware_perm, "Permissioned routes", "Permission checks")

' Middleware to API handlers
Rel(middleware_perm, api_auth, "Auth endpoints")
Rel(middleware_perm, api_groups, "Group endpoints")
Rel(middleware_perm, api_students, "Student endpoints")
Rel(middleware_perm, api_active, "Session endpoints")
Rel(middleware_perm, api_iot, "IoT endpoints")

' API handlers to services
Rel(api_auth, service_auth, "Business logic")
Rel(api_groups, service_education, "Business logic")
Rel(api_students, service_users, "Business logic")
Rel(api_active, service_active, "Business logic")
Rel(api_iot, service_iot, "Business logic")

' Services to repositories
Rel(service_auth, repo_account, "Data access")
Rel(service_education, repo_group, "Data access")
Rel(service_users, repo_student, "Data access")
Rel(service_active, repo_active, "Data access")
Rel(service_iot, repo_device, "Data access")

' Services to SSE hub
Rel(service_active, api_sse, "Broadcast events", "Check-in/out notifications")

' Repositories to ORM
Rel(repo_account, orm, "Query building")
Rel(repo_group, orm, "Query building")
Rel(repo_student, orm, "Query building")
Rel(repo_active, orm, "Query building")
Rel(repo_device, orm, "Query building")

' ORM to database
Rel(orm, database, "SQL queries", "Schema-qualified queries with SSL")

note right of router
  **Domain-based routing:**
  /api/auth/* → Auth API
  /api/groups/* → Groups API
  /api/students/* → Students API
  /api/active/* → Active Sessions API
  /iot/* → IoT API
end note

note right of middleware_perm
  **Permission format:**
  resource:action

  Examples:
  - groups:read
  - groups:write
  - admin:*
end note

note right of orm
  **Critical Pattern:**
  ModelTableExpr("education.groups AS \"group\"")

  Quotes required for multi-schema queries!
end note

SHOW_LEGEND()
@enduml
