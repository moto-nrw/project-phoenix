@startuml Project Phoenix - Frontend Component Diagram (C4 Level 3)
!include https://raw.githubusercontent.com/plantuml-stdlib/C4-PlantUML/master/C4_Component.puml

title Project Phoenix - Frontend Components (Next.js 15)

Person(user, "User", "Teacher or Admin")
Container_Ext(backend, "Backend API", "Go", "RESTful API with JWT auth")

Container_Boundary(frontend, "Frontend Web Application") {
    Component(app_router, "App Router", "Next.js 15", "File-based routing with Server Components")

    ' Pages (Server Components)
    Component(page_dashboard, "Dashboard Page", "app/dashboard", "Main dashboard with analytics")
    Component(page_myroom, "My Room Page", "app/myroom", "Supervisor's real-time room view")
    Component(page_groups, "Groups Page", "app/database/groups", "Group management")
    Component(page_students, "Students Page", "app/database/students", "Student management")

    ' API Routes (Proxy Layer)
    Component(api_proxy_auth, "Auth API Routes", "app/api/auth", "Login, logout, refresh proxies")
    Component(api_proxy_groups, "Groups API Routes", "app/api/groups", "Group CRUD proxies")
    Component(api_proxy_students, "Students API Routes", "app/api/students", "Student CRUD proxies")
    Component(api_proxy_active, "Active API Routes", "app/api/active", "Session management proxies")
    Component(api_proxy_sse, "SSE Proxy", "app/api/sse", "Server-Sent Events proxy")

    ' Client Components
    Component(comp_group_form, "Group Form", "components/groups", "Create/edit group form")
    Component(comp_student_card, "Student Card", "components/students", "Student display card")
    Component(comp_room_dashboard, "Room Dashboard", "components/active", "Real-time room occupancy")
    Component(comp_supervisor_select, "Supervisor Select", "components/groups", "Multi-select for supervisors")

    ' Service Layer
    Component(service_groups, "Group Service", "lib/active-service.ts", "Group business logic and type mapping")
    Component(service_students, "Student Service", "lib/students-service.ts", "Student business logic")
    Component(service_active, "Active Service", "lib/active-service.ts", "Real-time session management")

    ' API Client Layer
    Component(api_client, "API Client", "lib/api-client.ts", "Axios wrapper with token injection")
    Component(route_wrapper, "Route Wrapper", "lib/route-wrapper.ts", "JWT extraction and retry logic")

    ' Type Helpers
    Component(type_helpers, "Type Helpers", "lib/*-helpers.ts", "Backend ↔ Frontend type mapping")

    ' Authentication
    Component(nextauth, "NextAuth", "server/auth", "Session management with JWT strategy")
    Component(session_provider, "SessionProvider", "providers.tsx", "React Context for session")

    ' Real-Time
    Component(sse_hook, "useSSE Hook", "lib/hooks/use-sse.ts", "SSE connection with auto-reconnect")

    ' Contexts
    Component(ctx_supervision, "SupervisionContext", "lib/supervision-context.tsx", "User's group/room supervision state")
    Component(ctx_alert, "AlertContext", "contexts/AlertContext.tsx", "Global toast notifications")
    Component(ctx_modal, "ModalContext", "components/dashboard/modal-context.tsx", "Modal management")
}

' User to pages
Rel(user, page_dashboard, "Views", "HTTPS")
Rel(user, page_myroom, "Supervises room", "HTTPS")
Rel(user, page_groups, "Manages groups", "HTTPS")
Rel(user, page_students, "Manages students", "HTTPS")

' Pages to components
Rel(page_dashboard, comp_room_dashboard, "Renders")
Rel(page_myroom, comp_student_card, "Renders")
Rel(page_groups, comp_group_form, "Renders")
Rel(page_groups, comp_supervisor_select, "Renders")

' Components to services
Rel(comp_group_form, service_groups, "Calls")
Rel(comp_student_card, service_students, "Calls")
Rel(comp_room_dashboard, service_active, "Calls")

' Services to API routes
Rel(service_groups, api_proxy_groups, "fetch()", "POST /api/groups")
Rel(service_students, api_proxy_students, "fetch()", "GET /api/students")
Rel(service_active, api_proxy_active, "fetch()", "GET /api/active/groups")

' API routes to route wrapper
Rel(api_proxy_auth, route_wrapper, "Uses", "JWT extraction")
Rel(api_proxy_groups, route_wrapper, "Uses", "JWT extraction")
Rel(api_proxy_students, route_wrapper, "Uses", "JWT extraction")
Rel(api_proxy_active, route_wrapper, "Uses", "JWT extraction")

' Route wrapper to API client
Rel(route_wrapper, api_client, "Uses", "Axios requests")
Rel(route_wrapper, nextauth, "Gets session", "auth()")

' API client to backend
Rel(api_client, backend, "HTTP requests", "Bearer token")

' Type mapping
Rel(service_groups, type_helpers, "Maps types", "snake_case → camelCase, int64 → string")
Rel(service_students, type_helpers, "Maps types")
Rel(service_active, type_helpers, "Maps types")

' Real-time
Rel(comp_room_dashboard, sse_hook, "Uses", "Subscribe to events")
Rel(sse_hook, api_proxy_sse, "EventSource", "/api/sse/events")
Rel(api_proxy_sse, backend, "Proxies stream", "JWT injected server-side")

' Session management
Rel(app_router, session_provider, "Wraps", "SessionProvider")
Rel(session_provider, nextauth, "Uses", "Session state")
Rel(nextauth, api_proxy_auth, "Calls", "Login, refresh")

' Contexts
Rel(comp_room_dashboard, ctx_supervision, "Uses", "isSupervising state")
Rel(comp_group_form, ctx_alert, "Uses", "showAlert()")
Rel(page_dashboard, ctx_modal, "Uses", "openModal()")

note right of api_proxy_groups
  **Next.js 15 Async Params:**
  const params = await context.params

  **Route Wrapper Pattern:**
  - Extract JWT from session (server-side)
  - Inject Bearer token in request
  - Retry on 401 with token refresh
end note

note right of type_helpers
  **Type Mapping:**
  Backend: snake_case, int64
  Frontend: camelCase, string

  Example:
  room_id: 123 → roomId: "123"
end note

note right of sse_hook
  **Auto-Reconnect:**
  Exponential backoff
  1s → 2s → 4s → 8s → 16s
  Max 5 attempts

  Events are notifications,
  not full payloads
  (refetch data on event)
end note

SHOW_LEGEND()
@enduml
