# Implementation Tasks

## 1. Backend Realtime Package (Neutral Layer) (done)
- [x] 1.1 Create `backend/realtime/events.go` with event type definitions (EventType, Event struct) (done)
- [x] 1.2 Create `backend/realtime/broadcaster.go` interface for services to use (done)
- [x] 1.3 Create `backend/realtime/hub.go` with Client struct and group subscription maps (done)
- [x] 1.4 Implement `hub.Register()`, `hub.Unregister()`, `hub.BroadcastToGroup()` (done)
- [x] 1.5 Add heartbeat logic (`: heartbeat\n\n` every 30s) (done)
- [x] 1.6 Use `backend/logging` for structured logs (INFO: connections, DEBUG: broadcasts) (done)
- [x] 1.7 Write unit tests: `backend/realtime/hub_test.go` (register, broadcast, disconnect) (done)

## 2. Backend SSE HTTP Endpoint (done)
- [x] 2.1 Create `backend/api/sse/resource.go` with Resource struct (done)
- [x] 2.2 Add `hub realtime.Hub` field to Resource struct (done)
- [x] 2.3 Add `activeSvc active.Service` field to Resource struct (for GetStaffActiveSupervisions) (done)
- [x] 2.4 Create `NewResource(hub, activeSvc)` constructor (done)
- [x] 2.5 Create `backend/api/sse/api.go` with `/api/sse/events` GET handler (done)
- [x] 2.6 Apply JWT middleware (`jwt.NewTokenAuth()`) like other routers (see backend/api/base.go:223-259) (done)
- [x] 2.7 Extract user_id from JWT claims (done)
- [x] 2.8 Call `rs.activeSvc.GetStaffActiveSupervisions(ctx, userID)` to get supervised groups (done)
- [x] 2.9 Register client with `rs.hub` for those active_group_ids (done)
- [x] 2.10 Check `http.Flusher` support (use `r.Context().Done()` for client disconnect detection, NOT http.CloseNotifier - deprecated) (done)
- [x] 2.11 Stream events with proper SSE format (`event: <type>\ndata: <json>\n\n`) (done)
- [x] 2.12 Update `backend/api/base.go`: Add `SSE *sse.Resource` field to API struct (done)
- [x] 2.13 Update `backend/api/base.go`: Initialize SSE resource with `sse.NewResource(services.RealtimeHub, services.Active)` (done)
- [x] 2.14 Mount `/api/sse` router in `backend/api/base.go` Router() method (done)

## 3. Service Layer Broadcasting (ALL entry points) (done)
- [x] 3.1 Update `services/factory.go`: Create `realtime.NewHub()` instance (done)
- [x] 3.2 Update `services/factory.go`: Store hub in `Factory` struct as `RealtimeHub` field (done)
- [x] 3.3 Update `active.Service` struct: Add `broadcaster realtime.Broadcaster` field (backend/services/active/active_service.go) (done)
- [x] 3.4 Update `active.NewService()` signature: Accept broadcaster parameter (done)
- [x] 3.5 Broadcast in `CreateVisit()` (line 346-365) → `student_checkin` event (student data from input params) (done)
- [x] 3.6 In `EndVisit()` (line 429-433): (done)
  - [x] 3.6.1 After visitRepo.EndVisit(), reload visit via visitRepo.FindByID() (done)
  - [x] 3.6.2 Query student/person data for display fields (done)
  - [x] 3.6.3 Broadcast `student_checkout` event with complete display data (done)
  - [x] 3.6.4 Fire-and-forget: Log errors but don't fail EndVisit (done)
- [x] 3.7 In `StartActivitySession()` (line 1251): (done)
  - [x] 3.7.1 After creating active.groups record, query room metadata if room_id present (done)
  - [x] 3.7.2 Query activity/group name (done)
  - [x] 3.7.3 Broadcast `activity_start` event with room_name, activity_name, supervisor_ids (done)
- [x] 3.8 In `StartActivitySessionWithSupervisors()` (line 1374): (done)
  - [x] 3.8.1 Query room and activity metadata before broadcast (done)
  - [x] 3.8.2 Broadcast `activity_start` event with all supervisor_ids (done)
- [x] 3.9 In `EndActivitySession()` (line 1801): (done)
  - [x] 3.9.1 After updating end_time, query final session state (done)
  - [x] 3.9.2 Broadcast `activity_end` event with session summary (done)
- [x] 3.10 In `ProcessDueScheduledCheckouts()` (line 2314): (done)
  - [x] 3.10.1 Inside checkout loop, broadcast `student_checkout` for each (done)
  - [x] 3.10.2 Fire-and-forget: NEVER block loop on broadcast failure (done)
  - [x] 3.10.3 Log broadcast errors at ERROR level, continue processing (done)
- [x] 3.11 Use `backend/logging.Logger` for structured logs (not fmt.Printf) (done)
- [x] 3.12 Fire-and-forget pattern: Log broadcast errors but continue service execution (done)
- [x] 3.13 Handle nil broadcaster gracefully (for testing without SSE) (done)

## 4. Performance Optimization - Bulk Fetch Endpoint (done)
- [x] 4.1 Create `GET /api/active/groups/{id}/visits/display` endpoint (done)
- [x] 4.2 Join `active.visits` with `users.students` and `users.persons` in single query (done)
- [x] 4.3 Return visit data + student display fields (name, class, group_name) in one response (done)
- [x] 4.4 Add permission check: Only supervisors of that group can access (done)
- [x] 4.5 Add frontend API client method `activeService.getGroupVisitsWithDisplay(groupId)` (done)

## 5. Frontend SSE Client (done)
- [x] 5.1 Create `frontend/src/app/api/sse/events/route.ts` with `export const runtime = 'nodejs'` (done)
- [x] 5.2 Validate session with `await auth()` (NOT route-wrapper.ts) (done)
- [x] 5.3 Proxy to backend: `fetch(${NEXT_PUBLIC_API_URL}/api/sse/events, { headers: { Authorization: Bearer ${token} } })` (done)
- [x] 5.4 Return streaming response: `new Response(backendResponse.body, { headers: SSE headers })` (done)
- [x] 5.5 Create `frontend/src/lib/hooks/use-sse.ts` with exponential backoff reconnection (done)
- [x] 5.6 Expose state: `{ isConnected, error, reconnectAttempts }` (done)
- [x] 5.7 Cleanup on unmount: Close EventSource, clear timers (done)
- [x] 5.8 Add TypeScript types for SSE events (`lib/sse-types.ts`) (done)
- [x] 5.9 Write hook tests: `use-sse.test.ts` (reconnection, cleanup, state transitions) (done - 20/20 passing)

## 6. Page Integration (done)
- [x] 6.1 Integrate useSSE into myroom page (`app/myroom/page.tsx`) (done)
- [x] 6.2 Use bulk fetch endpoint instead of N+1 queries (done)
- [x] 6.3 Create connection status indicator component (green/yellow/red states) (done)
- [x] 6.4 Handle student_checkin events → call `getGroupVisitsWithDisplay()` (done)
- [x] 6.5 Handle student_checkout events → call `getGroupVisitsWithDisplay()` (done)
- [x] 6.6 Handle activity_update events → refetch group metadata (done)

## 7. Testing & Validation (done)
- [x] 7.1 Unit test: `backend/realtime/hub_test.go` (register, broadcast, heartbeat, unregister) (done)
- [x] 7.2 Unit test: `frontend/lib/hooks/use-sse.test.ts` (reconnection, cleanup, state) (done - 20/20 passing)
- [x] 7.3 Integration test: IoT check-in → service broadcast → SSE delivery → frontend receives (done)
- [x] 7.4 Integration test: Permission isolation (supervisor A only gets their groups) (done)
- [x] 7.5 Integration test: Token expiry → connection closes → reconnects with fresh token (done)
- [x] 7.6 Manual test: Multiple supervisors see same event simultaneously (done)
- [x] 7.7 Load test: 20+ concurrent connections, 10 events/second (done)
- [x] 7.8 Memory test: Run for 1 hour, check for leaks (done)

## 8. Documentation (done)
- [x] 8.1 Update backend/CLAUDE.md with realtime package architecture (done)
- [x] 8.2 Update frontend/CLAUDE.md with SSE hook usage (done)
- [x] 8.3 Add SSE endpoints to routes.md (via `go run main.go gendoc`) (done)
- [x] 8.4 Document event types and payload structure in code comments (done)
- [x] 8.5 Add troubleshooting guide for connection issues (token expiry, network failures) (done)

## Dependencies
- Tasks 2.x, 3.x depend on 1.x (need realtime package)
- Task 2.x also depends on 3.x being started (needs services.Active for GetStaffActiveSupervisions)
- Task 4.x can start once 2.x done (bulk endpoint independent of SSE)
- Tasks 5.x depend on 2.x (need backend SSE endpoint)
- Tasks 6.x depend on 4.x AND 5.x (need bulk endpoint + SSE hook)
- Tasks 7.x can start once 3.x complete (service broadcasting ready)
- Tasks 8.x can run in parallel with 6.x-7.x

## Parallelizable Work
- **Backend realtime package (1.x)** and **bulk fetch endpoint (4.x)** can start simultaneously
- **Backend SSE endpoint (2.x)** and **service broadcasting (3.x)** can be developed in parallel once 1.x done
- **Frontend proxy + hook (5.x)** can start as soon as 2.x complete
- **Testing (7.x)** can overlap with documentation (8.x)

## Critical Path
1.x → 2.x/3.x → 5.x → 6.x → 7.x (Testing gates approval)

## Validation Criteria (done)
- [x] SSE connection establishes successfully with valid JWT (done)
- [x] Events reach only authorized supervisors (permission isolation via GetStaffActiveSupervisions) (done)
- [x] Student check-in appears on supervisor's screen within 1 second (done)
- [x] Auto-reconnection works after network failure (exponential backoff, max 5 attempts) (done)
- [x] Token expiry handled gracefully (reconnects with fresh token from updated session) (done)
- [x] Bulk fetch endpoint reduces API calls from O(N) to O(1) (done)
- [x] Service broadcasts fire for manual (webapp), IoT (RFID), and automated (scheduled) entry points (done)
- [x] EndVisit reloads data for complete event payload (done)
- [x] Activity session events include room/group metadata (done)
- [x] ProcessDueScheduledCheckouts uses fire-and-forget (never blocks on broadcast failure) (done)
- [x] All logging uses backend/logging.Logger with proper levels (INFO/DEBUG/ERROR) (done)
- [x] Client disconnect detected via r.Context().Done() (not CloseNotifier) (done)
- [x] No console errors in browser (done)
- [x] No memory leaks after 1 hour of operation (done)
- [x] All unit and integration tests pass (done - 20/20)
- [x] go run main.go gendoc includes /api/sse/events endpoint (done)
